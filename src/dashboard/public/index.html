<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Honor Points - Admin Panel</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #0a0a0a;
            min-height: 100vh;
        }

        .glass-effect {
            background: rgba(20, 20, 20, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(139, 0, 0, 0.3);
        }

        .rank-1 {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, rgba(255, 215, 0, 0.05) 100%);
            border-left: 3px solid #FFD700;
        }

        .rank-2 {
            background: linear-gradient(135deg, rgba(192, 192, 192, 0.1) 0%, rgba(192, 192, 192, 0.05) 100%);
            border-left: 3px solid #C0C0C0;
        }

        .rank-3 {
            background: linear-gradient(135deg, rgba(205, 127, 50, 0.1) 0%, rgba(205, 127, 50, 0.05) 100%);
            border-left: 3px solid #CD7F32;
        }

        .table-row {
            transition: all 0.2s;
        }

        .table-row:hover {
            background: rgba(139, 0, 0, 0.1);
            transform: translateX(2px);
        }

        .modal-backdrop {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .btn-primary {
            background: linear-gradient(135deg, #8B0000 0%, #A00000 100%);
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #A00000 0%, #B50000 100%);
            box-shadow: 0 4px 12px rgba(139, 0, 0, 0.4);
        }

        .btn-secondary {
            background: rgba(60, 60, 60, 0.8);
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background: rgba(80, 80, 80, 0.8);
        }

        .input-field {
            background: rgba(30, 30, 30, 0.8);
            border: 1px solid rgba(139, 0, 0, 0.3);
            transition: all 0.2s;
        }

        .input-field:focus {
            border-color: #8B0000;
            outline: none;
            box-shadow: 0 0 0 3px rgba(139, 0, 0, 0.1);
        }
    </style>
</head>

<body class="text-gray-100">
    <!-- Header -->
    <header class="glass-effect border-b border-red-900/30 px-6 py-4">
        <div class="container mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold" style="color: #B8860B;">Honor Points Admin Panel</h1>
                <p class="text-sm text-gray-400 mt-1">Phantom Blade Zero - Leaderboard Management</p>
            </div>
            <div class="text-sm text-gray-400">
                Last Updated: <span id="lastUpdated">-</span>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container mx-auto px-6 py-8 max-w-7xl">
        <!-- Search Bar -->
        <div class="mb-6">
            <input type="text" id="searchInput" placeholder="Search by username..."
                class="input-field w-full px-4 py-3 rounded-lg text-white placeholder-gray-500"
                onkeyup="filterTable()" />
        </div>

        <!-- Loading State -->
        <div id="loading" class="flex justify-center items-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2" style="border-color: #8B0000;"></div>
            <span class="ml-4 text-gray-400">Loading leaderboard...</span>
        </div>

        <!-- Error State -->
        <div id="error" class="hidden text-center py-20">
            <div class="glass-effect border border-red-700 rounded-lg p-6 max-w-md mx-auto">
                <p class="text-red-300 text-lg mb-2">Failed to load leaderboard</p>
                <button onclick="loadLeaderboard()" class="btn-primary mt-4 px-6 py-2 rounded-lg">
                    Retry
                </button>
            </div>
        </div>

        <!-- Empty State -->
        <div id="empty" class="hidden text-center py-20">
            <p class="text-gray-400 text-xl">No users found.</p>
        </div>

        <!-- Leaderboard Table -->
        <div id="leaderboard" class="hidden">
            <div class="glass-effect rounded-lg overflow-hidden">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-red-900/30 bg-black/40">
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-300">Rank</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-300">Avatar</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-300">Username</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-300">Honor Points</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-300">Streak</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-300">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboardBody" class="divide-y divide-red-900/20">
                        <!-- Table rows will be rendered here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div class="modal-content glass-effect rounded-lg p-8 max-w-md w-full mx-4 border border-red-900/30">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold" style="color: #B8860B;">Edit User</h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>

            <div id="modalUserInfo" class="mb-6 p-4 rounded-lg bg-black/40">
                <!-- User info will be populated here -->
            </div>

            <form id="editForm" onsubmit="handleSubmit(event)">
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Honor Points</label>
                    <input type="number" id="pointsInput" min="0" step="1" required
                        class="input-field w-full px-4 py-2 rounded-lg text-white" />
                </div>

                <div class="flex space-x-4">
                    <button type="submit" class="btn-primary flex-1 px-6 py-3 rounded-lg font-semibold">
                        Update Points
                    </button>
                    <button type="button" onclick="handleResetStreak()"
                        class="btn-secondary px-6 py-3 rounded-lg font-semibold">
                        Reset Streak
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Dashboard script - updated to fix loading and TypeScript syntax issues
        const API_URL = '/api/leaderboard';
        let currentUsers = [];
        let currentEditUserId = null;

        // Load leaderboard on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadLeaderboard();
        });

        async function loadLeaderboard() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const empty = document.getElementById('empty');
            const leaderboard = document.getElementById('leaderboard');

            if (!loading || !error || !empty || !leaderboard) {
                console.error('[Dashboard] Required DOM elements not found');
                return;
            }

            loading.classList.remove('hidden');
            error.classList.add('hidden');
            empty.classList.add('hidden');
            leaderboard.classList.add('hidden');

            console.log('[Dashboard] Loading leaderboard from:', API_URL);

            try {
                // Add timeout to prevent hanging requests
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout

                let response;
                try {
                    response = await fetch(API_URL, {
                        credentials: 'include',
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                } catch (fetchError) {
                    clearTimeout(timeoutId);
                    if (fetchError.name === 'AbortError') {
                        throw new Error('Request timed out. Please check your connection and try again.');
                    }
                    throw fetchError;
                }

                // Check if response is OK
                if (!response.ok) {
                    if (response.status === 401) {
                        // Authentication required
                        console.error('Authentication required (401)');
                        error.classList.remove('hidden');
                        const errorMsg = error.querySelector('p');
                        if (errorMsg) {
                            errorMsg.textContent = 'Authentication failed. Please refresh the page and log in again.';
                        }
                        loading.classList.add('hidden');
                        return;
                    }
                    
                    // Try to get error message from response
                    let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    try {
                        const errorText = await response.text();
                        // Try to parse as JSON
                        try {
                            const errorJson = JSON.parse(errorText);
                            errorMessage = errorJson.error || errorMessage;
                        } catch {
                            // If not JSON, check if it's HTML
                            if (errorText && !errorText.trim().startsWith('<')) {
                                errorMessage = errorText;
                            }
                        }
                    } catch (e) {
                        console.error('Could not read error response:', e);
                    }
                    
                    throw new Error(errorMessage);
                }
                
                // Check content type before parsing JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Expected JSON but got:', contentType, text.substring(0, 200));
                    throw new Error('Invalid response format. Expected JSON but got: ' + (contentType || 'unknown'));
                }

                const result = await response.json();
                console.log('[Dashboard] Received leaderboard data:', result);

                if (!result.success) {
                    throw new Error(result.error || 'Failed to fetch leaderboard');
                }

                currentUsers = result.data || [];
                console.log('[Dashboard] Processed users:', currentUsers.length);

                if (result.lastUpdated) {
                    const lastUpdatedEl = document.getElementById('lastUpdated');
                    if (lastUpdatedEl) {
                        const date = new Date(result.lastUpdated);
                        lastUpdatedEl.textContent = date.toLocaleString();
                    }
                }

                if (currentUsers.length === 0) {
                    empty.classList.remove('hidden');
                } else {
                    renderLeaderboard(currentUsers);
                    leaderboard.classList.remove('hidden');
                }
                console.log('[Dashboard] Leaderboard rendered successfully');
            } catch (err) {
                console.error('Error loading leaderboard:', err);
                error.classList.remove('hidden');
                // Update error message if available
                const errorMessage = error.querySelector('p');
                if (errorMessage) {
                    if (err instanceof Error) {
                        errorMessage.textContent = err.message || 'Failed to load leaderboard';
                    } else {
                        const errorText = (err && err.message) ? err.message : (err ? err.toString() : 'Unknown error');
                        errorMessage.textContent = 'Failed to load leaderboard: ' + errorText + '. Check browser console (F12) for details.';
                    }
                }
            } finally {
                loading.classList.add('hidden');
            }
        }

        function renderLeaderboard(users) {
            const tbody = document.getElementById('leaderboardBody');
            tbody.innerHTML = '';

            users.forEach(user => {
                const rankClass = user.rank === 1 ? 'rank-1' : user.rank === 2 ? 'rank-2' : user.rank === 3 ? 'rank-3' : '';

                const medal = user.rank === 1 ? 'ðŸ¥‡' : user.rank === 2 ? 'ðŸ¥ˆ' : user.rank === 3 ? 'ðŸ¥‰' : '';

                const avatarUrl = `https://cdn.discordapp.com/avatars/${user.userId}/default.png?size=64`;

                const row = document.createElement('tr');
                row.className = `table-row ${rankClass}`;
                row.id = `user-row-${user.userId}`;

                // SECURITY: Escape all user input to prevent XSS
                const safeUserId = escapeHtml(String(user.userId));
                const safeUsername = escapeHtml(user.username);
                const safeHonorPoints = escapeHtml(String(user.honorPoints));
                const safeDailyStreak = escapeHtml(String(user.dailyStreak));
                const safeRank = escapeHtml(String(user.rank));
                const safeMedal = escapeHtml(String(medal || user.rank));

                row.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="flex items-center space-x-2">
                            <span class="font-bold text-lg">${safeMedal}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <img 
                            src="${escapeHtml(avatarUrl)}" 
                            alt="${safeUsername}" 
                            class="w-10 h-10 rounded-full border-2 ${user.rank <= 3 ? 'border-yellow-500' : 'border-gray-600'}"
                            onerror="this.src='https://cdn.discordapp.com/embed/avatars/${escapeHtml(String(user.userId % 5))}.png'"
                        />
                    </td>
                    <td class="px-6 py-4">
                        <div class="font-semibold" style="color: ${user.rank <= 3 ? '#B8860B' : '#E5E5E5'};">
                            ${safeUsername}
                        </div>
                        <div class="text-xs text-gray-500">${safeUserId}</div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="font-semibold" style="color: #8B0000;">
                            ${formatNumber(user.honorPoints)}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="text-gray-300">
                            ðŸ”¥ ${safeDailyStreak} day${parseInt(safeDailyStreak) !== 1 ? 's' : ''}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <button
                            class="btn-primary px-4 py-2 rounded-lg text-sm font-semibold edit-user-btn"
                            data-user-id="${safeUserId}"
                            data-username="${safeUsername.replace(/"/g, '&quot;')}"
                            data-honor-points="${parseInt(safeHonorPoints)}"
                            data-daily-streak="${parseInt(safeDailyStreak)}"
                        >
                            Edit
                        </button>
                    </td>
                `;

                tbody.appendChild(row);
            });
        }

        function filterTable() {
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            const filtered = currentUsers.filter(user =>
                user.username.toLowerCase().includes(searchInput)
            );
            renderLeaderboard(filtered);
        }

        function openEditModal(userId, username, honorPoints, streak) {
            currentEditUserId = userId;
            const modal = document.getElementById('editModal');
            const userInfo = document.getElementById('modalUserInfo');
            const pointsInput = document.getElementById('pointsInput');

            userInfo.innerHTML = `
                <div class="font-semibold text-lg">${escapeHtml(username)}</div>
                <div class="text-sm text-gray-400 mt-1">User ID: ${userId}</div>
                <div class="text-sm text-gray-400">Current Streak: ${streak} days</div>
            `;

            pointsInput.value = honorPoints;
            modal.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('editModal').classList.add('hidden');
            currentEditUserId = null;
        }

        async function handleSubmit(event) {
            event.preventDefault();
            const points = parseInt(document.getElementById('pointsInput').value);

            if (isNaN(points) || points < 0) {
                alert('Please enter a valid non-negative number');
                return;
            }

            try {
                const response = await fetch(`/api/user/${currentEditUserId}/points`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ points }),
                    credentials: 'include',
                });

                const result = await response.json();

                if (result.success) {
                    alert('Points updated successfully!');
                    closeModal();
                    loadLeaderboard();
                } else {
                    alert(`Error: ${result.error || 'Failed to update points'}`);
                }
            } catch (error) {
                console.error('Error updating points:', error);
                alert('Failed to update points. Please try again.');
            }
        }

        async function handleResetStreak() {
            if (!confirm('Are you sure you want to reset this user\'s streak?')) {
                return;
            }

            try {
                const response = await fetch(`/api/user/${currentEditUserId}/reset-streak`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                });

                const result = await response.json();

                if (result.success) {
                    alert('Streak reset successfully!');
                    closeModal();
                    loadLeaderboard();
                } else {
                    alert(`Error: ${result.error || 'Failed to reset streak'}`);
                }
            } catch (error) {
                console.error('Error resetting streak:', error);
                alert('Failed to reset streak. Please try again.');
            }
        }

        function formatNumber(num) {
            return num.toLocaleString();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Close modal on backdrop click
        document.getElementById('editModal').addEventListener('click', (e) => {
            if (e.target.id === 'editModal') {
                closeModal();
            }
        });

        // Auto-refresh every 30 seconds
        setInterval(loadLeaderboard, 30000);

        // SECURITY: Use event delegation to handle edit buttons (prevents XSS from inline onclick)
        document.addEventListener('DOMContentLoaded', () => {
            // Use event delegation for edit buttons
            document.addEventListener('click', (e) => {
                const target = e.target;
                if (!target || !(target instanceof HTMLElement)) return;

                const editBtn = target.closest('.edit-user-btn');
                if (editBtn && editBtn instanceof HTMLElement) {
                    const userId = editBtn.getAttribute('data-user-id');
                    const username = editBtn.getAttribute('data-username');
                    const honorPoints = parseInt(editBtn.getAttribute('data-honor-points') || '0');
                    const dailyStreak = parseInt(editBtn.getAttribute('data-daily-streak') || '0');

                    if (userId && username) {
                        openEditModal(userId, username, honorPoints, dailyStreak);
                    }
                }
            });
        });
    </script>
</body>

</html>